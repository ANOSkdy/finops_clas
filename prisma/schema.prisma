generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["queryCompiler", "driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  loginId      String   @unique @map("login_id")
  passwordHash String   @map("password_hash")
  name         String
  role         String   @default("user") // 'admin'|'user'
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  memberships Membership[]
  sessions    Session[]
  uploads     Upload[]
  emails      Email[]

  @@map("users")
}

model Company {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  legalForm          String   @map("legal_form") // 'corporation'|'sole'
  address            String?
  fiscalClosingMonth Int      @map("fiscal_closing_month")
  representativeName String?  @map("representative_name")
  contactEmail       String?  @map("contact_email")
  contactPhone       String?  @map("contact_phone")
  corporateNumber    String?  @map("corporate_number") @db.VarChar(13)
  establishedOn      DateTime? @map("established_on") @db.Date
  withholdingIncomeTaxPaymentSchedule String? @map("withholding_income_tax_payment_schedule")
  residentTaxPaymentSchedule  String? @map("resident_tax_payment_schedule")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  memberships Membership[]
  tasks       Task[]
  uploads     Upload[]
  ratings     Rating[]
  emails      Email[]
  sessions    Session[]

  @@map("companies")
}

model Membership {
  userId        String   @map("user_id") @db.Uuid
  companyId     String   @map("company_id") @db.Uuid
  roleInCompany String   @default("member") @map("role_in_company") // owner|admin|member|accountant
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@id([userId, companyId])
  @@map("memberships")
}

model Session {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  tokenHash       String   @unique @map("token_hash")
  activeCompanyId String?  @map("active_company_id") @db.Uuid
  expiresAt       DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastSeenAt      DateTime @default(now()) @map("last_seen_at") @db.Timestamptz(6)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeCompany Company? @relation(fields: [activeCompanyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("sessions")
}

model Task {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  category  String // tax|social|other
  title     String
  dueDate   DateTime @map("due_date") @db.Date
  status    String   @default("pending") // pending|done|overdue
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, dueDate])
  @@index([companyId, status])
  @@map("tasks")
}

model Upload {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId        String   @map("company_id") @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  purpose          String // rating|trial_balance
  storageProvider  String   @map("storage_provider") // vercel_blob|s3
  storageKey       String   @map("storage_key")
  originalFilename String   @map("original_filename")
  mimeType         String   @map("mime_type")
  sizeBytes        BigInt   @map("size_bytes")
  sha256           String?
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Restrict)
  rating  Rating?

  @@index([companyId, createdAt])
  @@map("uploads")
}

model Rating {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  uploadId  String   @unique @map("upload_id") @db.Uuid
  score     Int
  grade     String
  aiComment String?  @map("ai_comment")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  upload  Upload  @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@map("ratings")
}

model Email {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId           String   @map("company_id") @db.Uuid
  userId              String   @map("user_id") @db.Uuid
  mailTo              String   @map("mail_to")
  subject             String
  body                String
  attachmentUploadIds String[] @default([]) @map("attachment_upload_ids") @db.Uuid
  providerMessageId   String?  @map("provider_message_id")
  status              String   @default("queued") // queued|sent|failed
  error               String?
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([companyId, createdAt])
  @@map("emails")
}

model ManualDocument {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug      String   @unique
  title     String
  contentMd String   @map("content_md")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@map("manual_documents")
}

model AiCache {
  key       String   @id @db.Text
  value     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@map("ai_cache")
}
